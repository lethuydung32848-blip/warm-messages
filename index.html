window.addEventListener('load', () => {
    startAnimation();
});

function startAnimation() {
    startFirstPhase(() => {
        startSecondPhase();
    });
}

// 第一阶段：心形出现 → 自动消失
function startFirstPhase(callback) {
    const screenWidth = window.innerWidth;
    const screenHeight = window.innerHeight;
    const count = isMobile() ? 18 : 30;
    const scale = Math.min(screenWidth*0.8/32, screenHeight*0.6/30);
    const centerX = screenWidth/2;
    const centerY = isMobile() ? screenHeight/2-60 : screenHeight/2-80;

    const points = heartPoints(count);
    const messages = [...MESSAGES].sort(()=>Math.random()-0.5);
    const boxes = [];

    points.forEach((point, idx) => {
        setTimeout(() => {
            const x = centerX + point.x*scale - 150 + jitter(30);
            const y = centerY - point.y*scale - 50 + jitter(20);
            const color = randomPastelColor();
            const box = createMessageBox(x, y, color, messages[idx % messages.length]);
            box.style.opacity = '0';
            box.style.transform = 'scale(0.5)';
            document.body.appendChild(box);
            boxes.push(box);
            setTimeout(()=>{ box.style.transition='all 0.5s ease'; box.style.opacity='1'; box.style.transform='scale(1)'; },50);
        }, idx*80);
    });

    // 第一阶段结束后自动消失
    setTimeout(() => {
        boxes.forEach(box => { box.style.opacity='0'; box.style.transform='scale(0.5)'; });
        setTimeout(() => {
            boxes.forEach(box => { if(box.parentNode) box.parentNode.removeChild(box); });
            if(callback) callback();
        }, 300);
    }, count*80 + 1500); // 调整动画节奏
}

// 第二阶段：爆炸/散开消息 → 不消失
function startSecondPhase() {
    const screenWidth = window.innerWidth;
    const screenHeight = window.innerHeight;
    const explodeCount = isMobile() ? 12 : 20;
    const explodeMessages = [...MESSAGES].sort(()=>Math.random()-0.5);

    for(let i=0;i<explodeCount;i++){
        setTimeout(()=>{
            const x = 10 + Math.random()*(screenWidth-160);
            const y = 10 + Math.random()*(screenHeight-60);
            const color = randomPastelColor();
            const text = explodeMessages[i%explodeMessages.length];
            const box = createMessageBox(x,y,color,text);
            box.style.opacity='0';
            box.style.transform='scale(0.5)';
            document.body.appendChild(box);
            setTimeout(()=>{ box.style.transition='all 0.5s ease'; box.style.opacity='1'; box.style.transform='scale(1)';},50);
        }, i*80);
    }
}
